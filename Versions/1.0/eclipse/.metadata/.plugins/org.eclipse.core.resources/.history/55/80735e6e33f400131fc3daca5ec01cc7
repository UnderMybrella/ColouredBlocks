package org.abimon.mods.minecraft.dnc;

import java.util.Arrays;

import net.minecraft.command.CommandBase;
import net.minecraft.command.CommandException;
import net.minecraft.command.ICommandSender;
import net.minecraft.command.PlayerNotFoundException;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.entity.player.EntityPlayerMP;
import net.minecraft.item.ItemEditableBook;
import net.minecraft.item.ItemStack;
import net.minecraft.item.ItemWritableBook;
import net.minecraft.nbt.NBTBase;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.server.MinecraftServer;

public class CommandUseCommand extends CommandBase {

	@Override
	public String getCommandName() {
		return "useCommand";
	}

	@Override
	public String getCommandUsage(ICommandSender var1) {
		return "/useCommand";
	}

    public int getRequiredPermissionLevel()
	{
		return 2;
	}

	@Override
	public void processCommand(ICommandSender var1, String[] var2) {
		EntityPlayerMP player = null;

		if (var1 instanceof EntityPlayerMP)
		{
			player = (EntityPlayerMP)var1;
		}
		else
		{
			if(var2.length > 1)
			{
			String playerName = var2[1];
			EntityPlayerMP isPlayer = MinecraftServer.getServer().getConfigurationManager().getPlayerForUsername(playerName);
			if(isPlayer == null)
				throw new PlayerNotFoundException("You must specify which player you wish to perform this action on.", new Object[0]);
			player = isPlayer;
			}
			else
			{
				System.out.println(Arrays.toString(var2));
				return;
			}
		}
		
		ItemStack item = player.getHeldItem();
		if(item == null)
			throw new CommandException("Player " + player.getCommandSenderName() + " is not holding a writable book!");
		if(item.getItem() instanceof ItemWritableBook)
		{
			try
			{
				String command = joinPages(item.getTagCompound().getTag("pages"));
				System.out.println(command);
				MinecraftServer.getServer().getCommandManager().executeCommand(player, command);
			}
			catch(CommandException th)
			{
				throw th;
			}
		}
		else if(item.getItem() instanceof ItemEditableBook)
		{
			System.out.println(item.getTagCompound());
		}
	}

	private String joinPages(NBTBase tag) {
		if(tag instanceof NBTTagList)
		{
			String joined = "";
			NBTTagList list = (NBTTagList) tag;
			for(int i = 0; i < list.tagCount(); i++)
				joined += list.getStringTagAt(i);
			return joined;
		}
		return null;
	}

}
